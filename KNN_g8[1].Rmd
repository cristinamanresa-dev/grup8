---
title: "KNN"
author: "Gemma Galobart"
date: "2025-10-30"
output: html_document
---

```{r}
library(caret)
library(VIM)
library(kknn)
```


```{r}
# Cargamos la base de datos necesarios

dataTrain <- read.csv(file="train_pre.csv",header=TRUE, sep=",")
# variable resposta
y <- dataTrain$song_popularity
dataTest <- read.csv(file="test_pre.csv",header=TRUE, sep=",")
```

```{r}
## PACKAGES
library(caret)
library(FNN)
library(fastDummies)

## X i y
X <- dataTrain[, !names(dataTrain) %in% c("song_popularity")]
y <- dataTrain$song_popularity

## dummies per categòriques
X_dummies <- dummy_cols(X, remove_first_dummy = FALSE, remove_selected_columns = TRUE)

## escalar numeric
X_scaled <- scale(X_dummies)

## split train / test
set.seed(123)
trainIndex <- createDataPartition(y, p = 0.7, list = FALSE)
X_train <- X_scaled[trainIndex, ]
X_test  <- X_scaled[-trainIndex, ]
y_train <- y[trainIndex]
y_test  <- y[-trainIndex]

## KNN REGRESSIÓ CORRECTE (NO ARRODONEIX, NO DONA 0)
k <- 5
model_knn <- knn.reg(train = X_train, test = X_test, y = y_train, k = k)
pred <- model_knn$pred   # prediccions contínues, sense arrodonir

## avaluació regressió
RMSE <- sqrt(mean((pred - y_test)^2))
MAE <- mean(abs(pred - y_test))

## MAPE segur (sense zeros al denominador)
epsilon <- 1
MAPE <- mean(abs((pred - y_test) / (y_test + epsilon))) * 100

RMSE
MAE
MAPE

# SMAPE
smape_i <- 2 * abs(pred - y_test) / (abs(y_test) + abs(pred))
smape   <- mean(smape_i, na.rm = TRUE) * 100
smape

## buscar k òptim
results <- data.frame(k = integer(), RMSE = double())

for (k in 1:20) {
  model_k <- knn.reg(train = X_train, test = X_test, y = y_train, k = k)
  pred_k <- model_k$pred
  rmse_k <- sqrt(mean((pred_k - y_test)^2))
  results <- rbind(results, data.frame(k = k, RMSE = rmse_k))
}

print(results)
plot(results$k, results$RMSE, type="b")
```


