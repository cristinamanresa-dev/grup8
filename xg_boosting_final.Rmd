```{r}
library(readr)
library(caret)
library(xgboost)

dades <- read_csv("train_g_boost.csv")
test_f <- read_csv("test_g_boost.csv")

prepara_dades <- function(df) {
  df$prod_power <- df$loudness * df$energy
  df$happy_dance <- df$danceability * df$audio_valence
  df$intensity_tempo <- df$loudness * df$tempo
  
  df$acousticness <- as.factor(df$acousticness)
  df$instrumentalness <- as.factor(df$instrumentalness)
  df$speechiness <- as.factor(df$speechiness)
  
  df$time_signature <- NULL
  df$audio_mode <- NULL
  
  return(df)
}

dades <- prepara_dades(dades)
test_f <- prepara_dades(test_f)

set.seed(123)
train_index <- createDataPartition(dades$song_popularity, p = 0.8, list = FALSE)
train_set <- dades[train_index, ]
test_set  <- dades[-train_index, ]

grid_xgb_v2 <- expand.grid(
  nrounds = 2000,           
  max_depth = 8,            
  eta = 0.005,              
  gamma = 10,               
  colsample_bytree = 0.6, 
  min_child_weight = 1,
  subsample = 0.8
)

ctrl <- trainControl(method = "cv", number = 5)

model_final <- train(
  song_popularity ~ ., 
  data = train_set,
  method = "xgbTree",
  trControl = ctrl,
  tuneGrid = grid_xgb_v2,
  metric = "MAE"
)

pred_val <- predict(model_final, test_set)
rmse_val <- sqrt(mean((test_set$song_popularity - pred_val)^2))
cat("RMSE en conjunt de validació:", rmse_val, "\n")

residus <- test_set$song_popularity - pred_val
plot(pred_val, residus, main="Gràfic de Residus", xlab="Predicció", ylab="Error")
abline(h = 0, col = "red")

features_model <- model_final$coefnames
test_f_final <- test_f[, features_model]

prediccions_finals <- predict(model_final, newdata = test_f_final)

prediccions_finals <- pmax(0, pmin(100, prediccions_finals))

importancia <- varImp(model_final, scale = TRUE)
plot(importancia, top = 20, main = "Importància Final de Variables")

resultats <- data.frame(
  id = 1:nrow(test_f),
  song_popularity = round(prediccions_finals)
)

write.csv(resultats, "final_boost.csv", row.names = FALSE)
cat("Fitxer 'final_boost.csv' creat correctament.")
```


